"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.applyBlockToMenu = exports.declareGraphBlock = exports.iteratePropertyDefines = exports.getBlockDataByType = exports.getPropertyDefineByType = exports.getBlockTemplateByType = exports.declareShaderNodeBlock = exports.declareShaderGraph = void 0;
const block_1 = require("./block");
Object.defineProperty(exports, "declareShaderNodeBlock", { enumerable: true, get: function () { return block_1.declareShaderNodeBlock; } });
const menu_1 = require("../menu");
const block_forge_1 = require("../../block-forge");
const graph_1 = require("./graph");
const base_1 = require("../base");
let shaderNodeMap = new Map();
let shaderPropertyMap = new Map();
function getPropertyDefineByType(type) {
    return shaderPropertyMap.get(type);
}
exports.getPropertyDefineByType = getPropertyDefineByType;
async function declareGraphBlock() {
    const { shaderNodeList, shaderPropertyList } = await base_1.MessageMgr.Instance.callSceneMethod('queryShaderNode');
    shaderNodeMap = new Map(shaderNodeList);
    shaderPropertyMap = new Map(shaderPropertyList);
    declareShaderGraph();
    (0, block_1.declareShaderNodeBlock)(shaderNodeMap);
    applyBlockToMenu();
    base_1.MessageMgr.Instance.send(base_1.MessageType.Declared);
    base_1.MessageMgr.Instance.callSceneMethod('afterDeclared');
}
exports.declareGraphBlock = declareGraphBlock;
function iteratePropertyDefines(handle) {
    shaderPropertyMap.forEach((define) => handle(define));
}
exports.iteratePropertyDefines = iteratePropertyDefines;
async function getBlockDataByType(type) {
    let block = getBlockTemplateByType(type);
    if (!block) {
        await declareGraphBlock();
    }
    block = getBlockTemplateByType(type);
    if (!block) {
        console.log(`create default shader graph failed, MasterNode: ${type}`);
        return;
    }
    return JSON.parse(JSON.stringify(block.data));
}
exports.getBlockDataByType = getBlockDataByType;
function declareShaderGraph() {
    const defaultGraph = (0, graph_1.createDefaultGraph)();
    if ((0, block_forge_1.hasDeclareGraph)(defaultGraph.type))
        return;
    (0, block_forge_1.declareGraph)(defaultGraph);
}
exports.declareShaderGraph = declareShaderGraph;
function applyBlockToMenu() {
    block_1.normalBlockCacheMap.forEach((block) => {
        if (block.details?.menu) {
            menu_1.Menu.Instance.addItemPath(block.details.menu, {
                type: block.data.type,
                details: {},
            });
        }
    });
}
exports.applyBlockToMenu = applyBlockToMenu;
function getBlockTemplateByType(type) {
    const blockTemplate = block_1.normalBlockCacheMap.get(type);
    if (blockTemplate) {
        return JSON.parse(JSON.stringify(blockTemplate));
    }
    console.debug(`get block templates not available by type: ${type}`);
}
exports.getBlockTemplateByType = getBlockTemplateByType;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2hhZGVyLWdyYXBoL2RlY2xhcmUvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsbUNBR2lCO0FBeUViLHVHQTFFQSw4QkFBc0IsT0EwRUE7QUF4RTFCLGtDQUErQjtBQUMvQixtREFBa0U7QUFDbEUsbUNBQTZDO0FBQzdDLGtDQUFrRDtBQUlsRCxJQUFJLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQzlCLElBQUksaUJBQWlCLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUVsQyxTQUFTLHVCQUF1QixDQUFDLElBQVk7SUFDekMsT0FBTyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQThERywwREFBdUI7QUE1RDNCLEtBQUssVUFBVSxpQkFBaUI7SUFDNUIsTUFBTSxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRSxHQUFHLE1BQU0saUJBQVUsQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDNUcsYUFBYSxHQUFHLElBQUksR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3hDLGlCQUFpQixHQUFHLElBQUksR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFFaEQsa0JBQWtCLEVBQUUsQ0FBQztJQUNyQixJQUFBLDhCQUFzQixFQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3RDLGdCQUFnQixFQUFFLENBQUM7SUFFbkIsaUJBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGtCQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDL0MsaUJBQVUsQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3pELENBQUM7QUFvREcsOENBQWlCO0FBbERyQixTQUFTLHNCQUFzQixDQUFDLE1BQXdDO0lBQ3BFLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQXNCLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQzFFLENBQUM7QUErQ0csd0RBQXNCO0FBN0MxQixLQUFLLFVBQVUsa0JBQWtCLENBQUMsSUFBWTtJQUMxQyxJQUFJLEtBQUssR0FBRyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6QyxJQUFJLENBQUMsS0FBSyxFQUFFO1FBQ1IsTUFBTSxpQkFBaUIsRUFBRSxDQUFDO0tBQzdCO0lBQ0QsS0FBSyxHQUFHLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JDLElBQUksQ0FBQyxLQUFLLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLG1EQUFtRCxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZFLE9BQU87S0FDVjtJQUNELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ2xELENBQUM7QUFpQ0csZ0RBQWtCO0FBL0J0QixTQUFTLGtCQUFrQjtJQUN2QixNQUFNLFlBQVksR0FBRyxJQUFBLDBCQUFrQixHQUFFLENBQUM7SUFDMUMsSUFBSSxJQUFBLDZCQUFlLEVBQUMsWUFBWSxDQUFDLElBQUksQ0FBQztRQUFFLE9BQU87SUFFL0MsSUFBQSwwQkFBWSxFQUFDLFlBQVksQ0FBQyxDQUFDO0FBQy9CLENBQUM7QUFzQkcsZ0RBQWtCO0FBcEJ0QixTQUFTLGdCQUFnQjtJQUNyQiwyQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUF3QixFQUFFLEVBQUU7UUFDckQsSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRTtZQUNyQixXQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtnQkFDMUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSTtnQkFDckIsT0FBTyxFQUFFLEVBQUU7YUFDZCxDQUFDLENBQUM7U0FDTjtJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQWtCRyw0Q0FBZ0I7QUFoQnBCLFNBQVMsc0JBQXNCLENBQUMsSUFBWTtJQUN4QyxNQUFNLGFBQWEsR0FBRywyQkFBbUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEQsSUFBSSxhQUFhLEVBQUU7UUFDZixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO0tBQ3BEO0lBQ0QsT0FBTyxDQUFDLEtBQUssQ0FBQyw4Q0FBOEMsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUN4RSxDQUFDO0FBS0csd0RBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBCbG9ja1RlbXBsYXRlRGF0YSB9IGZyb20gJy4uL2ludGVybmFsJztcblxuaW1wb3J0IHtcbiAgICBub3JtYWxCbG9ja0NhY2hlTWFwLFxuICAgIGRlY2xhcmVTaGFkZXJOb2RlQmxvY2ssXG59IGZyb20gJy4vYmxvY2snO1xuaW1wb3J0IHsgTWVudSB9IGZyb20gJy4uL21lbnUnO1xuaW1wb3J0IHsgZGVjbGFyZUdyYXBoLCBoYXNEZWNsYXJlR3JhcGggfSBmcm9tICcuLi8uLi9ibG9jay1mb3JnZSc7XG5pbXBvcnQgeyBjcmVhdGVEZWZhdWx0R3JhcGggfSBmcm9tICcuL2dyYXBoJztcbmltcG9ydCB7IE1lc3NhZ2VNZ3IsIE1lc3NhZ2VUeXBlIH0gZnJvbSAnLi4vYmFzZSc7XG5pbXBvcnQgeyBQcm9wZXJ0eURlZmluZSB9IGZyb20gJy4uLy4uLy4uL0B0eXBlcy9zaGFkZXItbm9kZS10eXBlJztcbmltcG9ydCB7IEJsb2NrRGF0YSB9IGZyb20gJy4uLy4uL2Jsb2NrLWZvcmdlL2ludGVyZmFjZSc7XG5cbmxldCBzaGFkZXJOb2RlTWFwID0gbmV3IE1hcCgpO1xubGV0IHNoYWRlclByb3BlcnR5TWFwID0gbmV3IE1hcCgpO1xuXG5mdW5jdGlvbiBnZXRQcm9wZXJ0eURlZmluZUJ5VHlwZSh0eXBlOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gc2hhZGVyUHJvcGVydHlNYXAuZ2V0KHR5cGUpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZWNsYXJlR3JhcGhCbG9jaygpIHtcbiAgICBjb25zdCB7IHNoYWRlck5vZGVMaXN0LCBzaGFkZXJQcm9wZXJ0eUxpc3QgfSA9IGF3YWl0IE1lc3NhZ2VNZ3IuSW5zdGFuY2UuY2FsbFNjZW5lTWV0aG9kKCdxdWVyeVNoYWRlck5vZGUnKTtcbiAgICBzaGFkZXJOb2RlTWFwID0gbmV3IE1hcChzaGFkZXJOb2RlTGlzdCk7XG4gICAgc2hhZGVyUHJvcGVydHlNYXAgPSBuZXcgTWFwKHNoYWRlclByb3BlcnR5TGlzdCk7XG5cbiAgICBkZWNsYXJlU2hhZGVyR3JhcGgoKTtcbiAgICBkZWNsYXJlU2hhZGVyTm9kZUJsb2NrKHNoYWRlck5vZGVNYXApO1xuICAgIGFwcGx5QmxvY2tUb01lbnUoKTtcblxuICAgIE1lc3NhZ2VNZ3IuSW5zdGFuY2Uuc2VuZChNZXNzYWdlVHlwZS5EZWNsYXJlZCk7XG4gICAgTWVzc2FnZU1nci5JbnN0YW5jZS5jYWxsU2NlbmVNZXRob2QoJ2FmdGVyRGVjbGFyZWQnKTtcbn1cblxuZnVuY3Rpb24gaXRlcmF0ZVByb3BlcnR5RGVmaW5lcyhoYW5kbGU6IChkZWZpbmU6IFByb3BlcnR5RGVmaW5lKSA9PiB2b2lkKSB7XG4gICAgc2hhZGVyUHJvcGVydHlNYXAuZm9yRWFjaCgoZGVmaW5lOiBQcm9wZXJ0eURlZmluZSkgPT4gaGFuZGxlKGRlZmluZSkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRCbG9ja0RhdGFCeVR5cGUodHlwZTogc3RyaW5nKTogUHJvbWlzZTxCbG9ja0RhdGEgfCB1bmRlZmluZWQ+IHtcbiAgICBsZXQgYmxvY2sgPSBnZXRCbG9ja1RlbXBsYXRlQnlUeXBlKHR5cGUpO1xuICAgIGlmICghYmxvY2spIHtcbiAgICAgICAgYXdhaXQgZGVjbGFyZUdyYXBoQmxvY2soKTtcbiAgICB9XG4gICAgYmxvY2sgPSBnZXRCbG9ja1RlbXBsYXRlQnlUeXBlKHR5cGUpO1xuICAgIGlmICghYmxvY2spIHtcbiAgICAgICAgY29uc29sZS5sb2coYGNyZWF0ZSBkZWZhdWx0IHNoYWRlciBncmFwaCBmYWlsZWQsIE1hc3Rlck5vZGU6ICR7dHlwZX1gKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShibG9jay5kYXRhKSk7XG59XG5cbmZ1bmN0aW9uIGRlY2xhcmVTaGFkZXJHcmFwaCgpIHtcbiAgICBjb25zdCBkZWZhdWx0R3JhcGggPSBjcmVhdGVEZWZhdWx0R3JhcGgoKTtcbiAgICBpZiAoaGFzRGVjbGFyZUdyYXBoKGRlZmF1bHRHcmFwaC50eXBlKSkgcmV0dXJuO1xuXG4gICAgZGVjbGFyZUdyYXBoKGRlZmF1bHRHcmFwaCk7XG59XG5cbmZ1bmN0aW9uIGFwcGx5QmxvY2tUb01lbnUoKSB7XG4gICAgbm9ybWFsQmxvY2tDYWNoZU1hcC5mb3JFYWNoKChibG9jazogQmxvY2tUZW1wbGF0ZURhdGEpID0+IHtcbiAgICAgICAgaWYgKGJsb2NrLmRldGFpbHM/Lm1lbnUpIHtcbiAgICAgICAgICAgIE1lbnUuSW5zdGFuY2UuYWRkSXRlbVBhdGgoYmxvY2suZGV0YWlscy5tZW51LCB7XG4gICAgICAgICAgICAgICAgdHlwZTogYmxvY2suZGF0YS50eXBlLFxuICAgICAgICAgICAgICAgIGRldGFpbHM6IHt9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0QmxvY2tUZW1wbGF0ZUJ5VHlwZSh0eXBlOiBzdHJpbmcpOiBCbG9ja1RlbXBsYXRlRGF0YSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgYmxvY2tUZW1wbGF0ZSA9IG5vcm1hbEJsb2NrQ2FjaGVNYXAuZ2V0KHR5cGUpO1xuICAgIGlmIChibG9ja1RlbXBsYXRlKSB7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGJsb2NrVGVtcGxhdGUpKTtcbiAgICB9XG4gICAgY29uc29sZS5kZWJ1ZyhgZ2V0IGJsb2NrIHRlbXBsYXRlcyBub3QgYXZhaWxhYmxlIGJ5IHR5cGU6ICR7dHlwZX1gKTtcbn1cblxuZXhwb3J0IHtcbiAgICBkZWNsYXJlU2hhZGVyR3JhcGgsXG4gICAgZGVjbGFyZVNoYWRlck5vZGVCbG9jayxcbiAgICBnZXRCbG9ja1RlbXBsYXRlQnlUeXBlLFxuICAgIGdldFByb3BlcnR5RGVmaW5lQnlUeXBlLFxuICAgIGdldEJsb2NrRGF0YUJ5VHlwZSxcbiAgICBpdGVyYXRlUHJvcGVydHlEZWZpbmVzLFxuICAgIGRlY2xhcmVHcmFwaEJsb2NrLFxuICAgIGFwcGx5QmxvY2tUb01lbnUsXG59O1xuIl19